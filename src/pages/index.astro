---
import PublicLayout from '../layouts/PublicLayout.astro';
import { initDatabase } from '../db/index';
import { db } from '../db/index';
import { categories, menuItems } from '../db/schema';
import { eq, asc, inArray } from 'drizzle-orm';
import { seedData } from '../scripts/seed-data';

// Inicializar base de datos de forma segura
let dbInitialized = false;
try {
  await initDatabase();
  dbInitialized = true;
} catch (error: any) {
  console.error('Error inicializando base de datos:', error.message || error);
  // Continuar aunque falle la inicializaci√≥n
}

// Verificar si hay items en la base de datos, si no, cargar datos
let itemCount = [];
let activeCategories = [];

if (dbInitialized) {
  try {
    itemCount = await db.select().from(menuItems).limit(1);
  } catch (error) {
    console.error('Error verificando items:', error);
  }

  // Solo cargar datos si la base de datos est√° realmente vac√≠a
  // NO ejecutar autom√°ticamente en producci√≥n para evitar duplicados
  const isProduction = import.meta.env.PROD;
  if (itemCount.length === 0 && !isProduction) {
    console.log('üì¶ Base de datos vac√≠a (desarrollo), cargando datos iniciales...');
    try {
      await seedData(false); // No forzar limpieza
      console.log('‚úÖ Datos cargados correctamente');
    } catch (error: any) {
      console.error('‚ùå Error cargando datos:', error.message || error);
    }
  } else if (itemCount.length === 0 && isProduction) {
    console.log('‚ö†Ô∏è Base de datos vac√≠a en producci√≥n. Usa /api/seed para cargar datos manualmente.');
  }

  // Obtener solo categor√≠as que tienen items disponibles
  try {
    // Obtener IDs de categor√≠as que tienen items disponibles
    const categoriesWithItems = await db
      .selectDistinct({ categoryId: menuItems.categoryId })
      .from(menuItems)
      .where(eq(menuItems.isAvailable, true));
    
    const categoryIds = categoriesWithItems
      .map(c => c.categoryId)
      .filter(id => id !== null) as number[];
    
    if (categoryIds.length > 0) {
      // Usar consulta con IN para obtener solo categor√≠as con items
      const { inArray } = await import('drizzle-orm');
      activeCategories = await db.select().from(categories)
        .where(eq(categories.isActive, true))
        .where(inArray(categories.id, categoryIds))
        .orderBy(asc(categories.order), asc(categories.name));
    } else {
      activeCategories = [];
    }
  } catch (error) {
    console.error('Error loading categories:', error);
    activeCategories = [];
  }
}
---

<PublicLayout title="Men√∫ Digital - Gourmet √Årabe">
  <div class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="mb-8">
        <div class="w-48 h-48 md:w-64 md:h-64 mx-auto mb-8 animate-float">
          <img 
            src="/logo-cropped.png" 
            alt="Gourmet √Årabe Logo" 
            class="w-full h-full object-contain rounded-full shadow-2xl"
            style="box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);"
          />
        </div>
      </div>

      {activeCategories.length > 0 ? (
        <div class="space-y-4">
          <p class="text-gold-300 text-xl mb-6 px-6 py-3 bg-black/70 backdrop-blur-sm rounded-lg border-2 border-gold-600 inline-block mx-auto" style="text-shadow: 0 0 10px rgba(212, 175, 55, 0.5), 2px 2px 4px rgba(0, 0, 0, 0.8);">Selecciona una categor√≠a del men√∫:</p>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-4xl mx-auto">
            {activeCategories.map((category) => (
              <a
                href={`/${category.slug}`}
                class="px-6 py-4 bg-gold-600 hover:bg-gold-500 text-black font-bold rounded-lg transition transform hover:scale-105 shadow-lg border-2 border-gold-400 hover:border-gold-300 text-lg"
              >
                {category.name}
              </a>
            ))}
          </div>
        </div>
      ) : (
        <div class="text-center py-12">
          <p class="text-gold-400 text-xl mb-4 px-6 py-3 bg-black/70 backdrop-blur-sm rounded-lg border-2 border-gold-600 inline-block" style="text-shadow: 0 0 10px rgba(212, 175, 55, 0.5), 2px 2px 4px rgba(0, 0, 0, 0.8);">No hay categor√≠as disponibles</p>
          <p class="text-gold-300 mb-6 px-4 py-2 bg-black/60 backdrop-blur-sm rounded-lg inline-block">Cargando datos iniciales del men√∫...</p>
          <button 
            id="load-data-btn"
            class="px-6 py-3 bg-gold-600 hover:bg-gold-500 text-black font-bold rounded-lg transition"
          >
            Cargar Datos del Men√∫
          </button>
          <p class="text-gold-300 text-sm mt-4 px-4 py-2 bg-black/60 backdrop-blur-sm rounded-lg inline-block">O inicia sesi√≥n en el <a href="/admin/login" class="text-gold-400 hover:text-gold-300 underline">panel de administraci√≥n</a></p>
        </div>
      )}
    </div>
  </div>

  <footer class="bg-black/70 backdrop-blur-sm border-t-4 border-gold-600 mt-16 py-8">
    <div class="max-w-7xl mx-auto px-4 text-center space-y-3">
        <p class="text-gold-400 font-playfair text-lg">
          Gourmet √Årabe - Sabores Aut√©nticos del Medio Oriente
        </p>
        <div class="pt-2 border-t border-gold-600/30">
          <a 
            href="/admin/login" 
            class="text-gold-300 hover:text-gold-400 text-sm underline transition-colors"
            title="Acceso Administrativo"
          >
            üîê Acceso Admin
          </a>
        </div>
    </div>
  </footer>
</PublicLayout>

<script>
  // Bot√≥n para cargar datos manualmente
  const loadBtn = document.getElementById('load-data-btn');
  if (loadBtn) {
    loadBtn.addEventListener('click', async () => {
      loadBtn.disabled = true;
      loadBtn.textContent = 'Cargando...';
      try {
        const response = await fetch('/api/seed');
        const data = await response.json();
        if (data.success) {
          alert('‚úÖ Datos cargados correctamente. Recarga la p√°gina.');
          window.location.reload();
        } else {
          alert('Error: ' + (data.error || 'No se pudieron cargar los datos'));
          loadBtn.disabled = false;
          loadBtn.textContent = 'Cargar Datos del Men√∫';
        }
      } catch (error) {
        alert('Error al cargar datos: ' + error);
        loadBtn.disabled = false;
        loadBtn.textContent = 'Cargar Datos del Men√∫';
      }
    });
  }
</script>



