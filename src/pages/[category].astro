---
import PublicLayout from '../layouts/PublicLayout.astro';
import MenuSection from '../components/public/MenuSection';
import ComboMenusSection from '../components/public/ComboMenusSection';
import { initDatabase } from '../db/index';
import { db } from '../db/index';
import { categories, menuItems } from '../db/schema';
import { eq, asc, inArray } from 'drizzle-orm';

await initDatabase();

// Obtener solo categor√≠as que tienen items disponibles para la navegaci√≥n
let allCategories = [];
try {
  // Obtener IDs de categor√≠as que tienen items disponibles
  const categoriesWithItems = await db
    .selectDistinct({ categoryId: menuItems.categoryId })
    .from(menuItems)
    .where(eq(menuItems.isAvailable, true));
  
  const categoryIds = categoriesWithItems
    .map(c => c.categoryId)
    .filter(id => id !== null) as number[];
  
  if (categoryIds.length > 0) {
    allCategories = await db.select().from(categories)
      .where(eq(categories.isActive, true))
      .where(inArray(categories.id, categoryIds))
      .orderBy(asc(categories.order), asc(categories.name));
  } else {
    allCategories = [];
  }
} catch (error) {
  console.error('Error loading categories:', error);
  allCategories = [];
}

// Obtener la categor√≠a actual desde el par√°metro
const categorySlug = Astro.params.category || 'entradas';
const currentCategory = allCategories.find(cat => cat.slug === categorySlug) || allCategories[0];
---

<PublicLayout title={`${currentCategory?.name || 'Men√∫'} - Gourmet √Årabe`}>
  <header class="sticky top-0 z-50 bg-black/70 backdrop-blur-sm border-b-4 border-gold-600 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex items-center justify-center gap-4 mb-6">
        <div class="w-24 h-24 md:w-28 md:h-28 animate-float">
          <img 
            src="/logo-cropped.png" 
            alt="Gourmet √Årabe Logo" 
            class="w-full h-full object-contain rounded-full shadow-xl"
            style="box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);"
          />
        </div>
      </div>
      
      <nav class="flex flex-wrap justify-center gap-2">
        {allCategories.map((category) => (
          <a
            href={`/${category.slug}`}
            class={`px-4 py-2 font-semibold rounded transition border-2 ${
              category.slug === categorySlug
                ? 'bg-gold-600 text-black border-gold-400'
                : 'bg-gray-800 text-gold-400 border-gold-600 hover:bg-gold-600 hover:text-black hover:border-gold-400'
            }`}
          >
            {category.name}
          </a>
        ))}
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 min-h-screen">
    {currentCategory ? (
      currentCategory.slug === 'menus-combinados' ? (
        <ComboMenusSection client:load />
      ) : (
        <div>
          <MenuSection category={JSON.stringify(currentCategory)} client:load />
        </div>
      )
    ) : (
      <div class="text-center py-12">
        <p class="text-gold-400 text-xl mb-4">Categor√≠a no encontrada</p>
        <a href="/" class="text-gold-300 hover:text-gold-400 underline">Volver al inicio</a>
      </div>
    )}
  </main>

  <footer class="bg-black/70 backdrop-blur-sm border-t-4 border-gold-600 mt-16 py-8">
    <div class="max-w-7xl mx-auto px-4 text-center space-y-3">
        <p class="text-gold-400 font-playfair text-lg">
          Gourmet √Årabe - Sabores Aut√©nticos del Medio Oriente
        </p>
        <div class="pt-2 border-t border-gold-600/30">
          <a 
            href="/admin/login" 
            class="text-gold-300 hover:text-gold-400 text-sm underline transition-colors"
            title="Acceso Administrativo"
          >
            üîê Acceso Admin
          </a>
        </div>
    </div>
  </footer>
</PublicLayout>

